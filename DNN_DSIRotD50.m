function [DSI, sigma, phi, tau] = DNN_DSIRotD50(input_Mw,input_Rrup,input_Vs30,input_Frv,input_Fnm)

% Created by Mao-Xin Wang (dr.maoxin.wang@gmail.com or maoxin.wang@polyu.edu.hk)
% December 2023
%
% Predict RotD50 value of DSI
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% INPUT
%
%   input_Mw     = scalar or matrix of inputted moment magnitude
%   input_Rrup   = scalar or matrix of inputted rupture distance
%   input_Vs30   = scalar or matrix of inputted upper 30 m shear-wave velocity
%   input_Frv    = scalar or matrix of inputted reverse-faulting indicator
%   input_Fnm    = scalar or matrix of inputted normal-faulting indicator
%                  (Note: the above inputs must be in the same dimension)
%
% OUTPUT
%
%   DSI          = median displacement spectrum intensity
%   sigma        = logarithmic total standard deviation
%   phi          = logarithmic within-event standard deviation
%   tau          = logarithmic between-event standard deviation
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% specify model coefficients
X_min = [3.0500 	-1.5606 	4.4922 	0.0000 	0.0000];
X_max = [7.9000 	5.9910 	7.2889 	1.0000 	1.0000];

W1 = [
    -0.4666 	-1.2880 	-0.2696 	1.2350 	-0.3761 	0.9381 	0.0660 	-0.3419 	-1.4905 	-0.6216 	-1.9605 	2.1023 	0.1307 	-2.6781 	0.9017 	1.1040
    1.1507 	1.3622 	1.7075 	-1.0549 	1.8399 	-0.7599 	0.7457 	1.5028 	0.8546 	1.9501 	0.4052 	0.4092 	-0.3684 	-0.4389 	-0.6080 	-0.9149
    0.6009 	-0.4080 	0.1650 	0.3841 	-0.4782 	-0.4359 	3.9215 	0.0617 	-0.2111 	1.2679 	2.1495 	0.1428 	1.6127 	-0.2920 	-0.7912 	-0.3217
    0.3361 	0.3398 	0.2532 	-0.3855 	-0.4454 	0.0673 	0.0194 	0.0834 	0.3116 	0.1694 	-1.8613 	0.8068 	-0.4371 	-0.7764 	-0.0274 	-0.0519
    -0.0654 	0.2534 	0.2137 	-0.0405 	-0.1239 	0.1188 	-0.0713 	0.0043 	-0.3096 	-0.0573 	0.0356 	-0.0744 	1.2504 	0.1732 	0.1928 	-0.4380
    ];

b1 = [
    -0.5854 	-0.5069 	-0.4104 	0.3359 	-0.1631 	0.7108 	-0.6949 	-0.5388 	-0.5748 	0.0482 	-0.3550 	0.9230 	0.0238 	-0.7742 	0.5176 	0.5299
    ];

W2 = [
    0.0126 	0.3967 	0.0120 	-0.7274 	0.6009 	0.4112 	0.3613 	0.0328 	0.3570 	0.3342 	-0.6344 	0.5729 	1.0646 	0.0962 	-0.0394 	0.5523
    -0.8401 	0.3389 	-0.5935 	-0.9679 	0.2096 	0.9532 	0.8303 	1.0353 	0.8003 	0.8633 	-0.7378 	0.7112 	1.1147 	-0.7998 	0.6494 	0.5176
    -0.1934 	0.7302 	-0.0377 	-0.0823 	0.1441 	0.8091 	-0.1021 	0.7063 	0.4111 	0.5827 	-0.0447 	1.0976 	0.6381 	-0.3326 	0.5427 	-0.0764
    1.0302 	-0.7048 	1.1082 	1.2384 	-0.9312 	-0.6588 	-0.9816 	-1.0005 	-0.8678 	-0.6822 	0.8939 	-0.5595 	-0.2344 	1.3232 	-1.1517 	-0.8298
    -0.4374 	0.1782 	-0.5627 	-0.4682 	0.0546 	0.7545 	-0.0793 	0.8044 	0.2132 	-0.0796 	-0.2357 	0.9018 	0.2932 	-0.0878 	-0.2276 	0.0356
    0.9095 	-1.4279 	0.8831 	1.0310 	-0.5020 	-0.1724 	-0.8784 	-0.5714 	-0.7545 	-1.0148 	1.3100 	-0.5224 	-1.1472 	1.2929 	-1.3076 	-1.2572
    -0.5317 	0.3706 	-0.7896 	-0.1298 	0.4678 	0.5976 	0.4212 	0.2292 	-0.0299 	1.0095 	-0.7985 	0.9376 	1.1846 	-0.2476 	0.7419 	0.4057
    0.2406 	0.1612 	0.0731 	-0.0690 	0.5291 	0.4043 	0.4252 	0.8543 	0.1225 	0.1407 	0.1505 	0.7356 	0.2641 	-0.3030 	0.3719 	0.1218
    -0.8667 	0.3890 	-0.1754 	-0.4388 	0.7256 	0.7439 	0.8151 	0.6212 	0.5344 	0.4843 	-0.8510 	0.4346 	1.1157 	-0.7870 	0.8036 	0.5430
    -0.1565 	-0.2010 	-0.1456 	-0.0733 	-0.5257 	0.2196 	0.1398 	0.5032 	-0.3379 	-0.6003 	-0.0992 	1.0106 	0.2711 	0.1923 	0.0170 	-0.2790
    0.1987 	-0.2518 	-0.3465 	0.4116 	0.0693 	0.7313 	-0.3107 	0.7285 	0.0921 	0.0662 	0.2624 	1.4724 	1.1172 	-0.1736 	-0.0942 	0.2859
    0.5883 	-0.4505 	0.4511 	-0.1385 	-0.7767 	-0.8227 	-0.7032 	-0.4668 	-0.4743 	-0.5286 	0.5738 	-0.4374 	-0.1914 	0.1306 	-0.2287 	-0.6166
    0.2662 	-0.4719 	0.6503 	0.6617 	-0.6352 	-0.2328 	-0.7777 	-0.2649 	-0.7477 	0.1147 	0.1687 	0.6207 	-0.0065 	0.0129 	-0.5606 	-0.0329
    -0.8915 	0.8837 	-0.4367 	0.0488 	0.5934 	1.4533 	0.9510 	1.6035 	0.7990 	1.1741 	-0.8759 	2.1533 	1.6830 	-0.6072 	0.0357 	0.7156
    0.9751 	-1.1889 	0.5745 	0.9189 	-0.6355 	-0.2062 	-0.1641 	-0.2267 	-0.7861 	-1.3489 	0.5459 	-0.9950 	-0.1979 	1.2658 	-0.9652 	-1.1106
    0.6204 	-1.4224 	0.9240 	0.8706 	-1.3021 	-0.3278 	-0.9572 	-0.5567 	-0.9297 	-1.4513 	1.2115 	-1.0680 	-0.1932 	1.3049 	-0.7392 	-1.2630
    ];

b2 = [
    0.3367 	-0.4105 	0.4273 	0.3278 	-0.4483 	-0.2830 	-0.3212 	-0.3346 	-0.3470 	-0.5525 	0.5392 	-0.0751 	-0.1129 	0.5424 	-0.5436 	-0.5097
    ];

W3 = [
    -0.4524 	0.7770 	-0.7179 	0.1282 	-0.6451 	0.6606 	0.8838 	0.7550 	-0.1009 	-0.6537 	-0.5541 	-0.6793 	-1.2664 	0.5874 	0.0069 	0.4801
    0.8773 	-0.5527 	0.7184 	-0.2698 	1.0340 	-0.6712 	-0.5655 	-0.7617 	0.5820 	0.6643 	0.5524 	0.7616 	1.2733 	-0.4281 	-0.3009 	-0.7863
    -0.4200 	0.1432 	-0.3069 	0.2945 	-0.1269 	0.8288 	1.0769 	0.6257 	-0.5720 	-0.9382 	-0.2973 	-1.3631 	-1.0645 	0.3649 	0.6170 	0.2658
    -0.6539 	0.6074 	-0.8852 	0.2978 	-0.5830 	0.5017 	0.9348 	0.4539 	-0.7147 	-1.0346 	-0.3142 	-0.8440 	-1.4144 	0.5837 	0.7215 	0.3712
    0.3256 	0.0268 	0.2049 	-0.7299 	0.3122 	-0.3894 	-0.6866 	-0.7834 	0.3840 	0.1098 	0.4885 	0.7881 	0.1826 	-0.6371 	-0.4435 	-0.3352
    0.1995 	-0.6637 	0.5977 	-0.7883 	0.7567 	-0.6561 	-0.2707 	-0.4418 	0.6970 	0.2798 	0.8735 	-0.0239 	-0.1716 	-0.5253 	-0.3474 	-0.9647
    0.6317 	-0.7978 	0.6357 	-1.0255 	0.2940 	-0.7971 	-0.4601 	-0.5159 	0.6043 	0.7556 	0.9083 	0.3156 	0.2742 	-0.3793 	-0.3539 	-0.8643
    0.8187 	-0.2600 	0.3862 	-0.2558 	-0.0478 	-0.2218 	0.1849 	0.0459 	0.6359 	0.2236 	0.5437 	-0.0003 	0.4049 	0.0812 	-0.9722 	-0.9523
    1.0028 	-0.2075 	0.7126 	-0.3363 	0.7757 	-0.4262 	-0.3620 	-0.6033 	0.2564 	0.5307 	0.7670 	0.6496 	0.6875 	-0.9136 	-0.9454 	-0.5165
    0.8076 	-1.2178 	0.3845 	-0.2713 	0.6389 	-0.6449 	-0.9195 	-0.9227 	0.8813 	0.3530 	0.4052 	0.4850 	0.7374 	-1.1397 	-0.9269 	-0.1926
    -0.3125 	1.0365 	-0.3330 	0.7946 	-0.2707 	0.9041 	1.3171 	0.7008 	-0.2297 	-0.9971 	-0.8192 	-1.5831 	-0.8686 	0.8701 	0.2809 	0.4287
    1.0193 	-0.2458 	0.4766 	-0.7636 	0.7089 	0.1560 	0.2576 	-0.6198 	0.7041 	0.2048 	0.6936 	-0.1786 	-0.2824 	-0.3675 	-0.9146 	-0.9380
    0.4756 	-0.3247 	0.4255 	-0.7422 	-0.0092 	-0.3084 	0.0467 	-0.1329 	0.5635 	-0.4896 	0.9025 	0.2041 	-0.2207 	0.0883 	-0.4610 	-0.7588
    -0.4288 	0.6724 	-0.2656 	0.8102 	-0.8909 	0.6165 	0.9295 	0.6689 	-0.6818 	-1.3190 	-0.3544 	-1.4298 	-1.4860 	0.3227 	0.5381 	0.8185
    0.4961 	-0.8176 	0.8985 	-0.1989 	0.5440 	-0.2667 	-0.6224 	-0.3966 	0.7955 	0.6134 	0.5468 	0.8860 	1.0325 	-0.6258 	-0.2724 	-0.1902
    0.7215 	-0.4181 	0.8190 	-0.5590 	0.8147 	-0.9168 	-0.8374 	-0.2680 	0.6881 	0.4864 	0.3713 	0.4369 	0.9458 	-0.7659 	-0.2395 	-0.5746
    ];

b3 = [
    -0.1805 	0.1261 	-0.0597 	-0.1247 	-0.1129 	0.0789 	0.3771 	0.0951 	-0.1371 	-0.3404 	-0.0725 	-0.3401 	-0.3119 	0.1003 	-0.0918 	-0.0201
    ];

W_out = [
    -0.9035 	0.9787 	-1.3343 	0.8786 	-1.2334 	0.9904 	0.8554 	0.9890 	-0.9621 	-1.2980 	-1.0042 	-1.3542 	-1.6600 	0.7973 	0.8131 	0.9039
    ]';

b_out = [-0.4256];

%% perform median prediction
[n_row,n_col] = size(input_Mw);
n_data = n_row*n_col;
X_Mw = reshape(input_Mw,n_data,1);
X_lnR = reshape(log(input_Rrup),n_data,1);
X_lnVs30 = reshape(log(input_Vs30),n_data,1);
X_Frv = reshape(input_Frv,n_data,1);
X_Fnm = reshape(input_Fnm,n_data,1);

X_norm = 2*([X_Mw,X_lnR,X_lnVs30,X_Frv,X_Fnm]-repmat(X_min,[n_data,1]))./(repmat(X_max-X_min,[n_data,1]))-1;
Y = sigmoid(sigmoid(sigmoid(X_norm*W1+b1)*W2+b2)*W3+b3)*W_out+b_out;
DSI = reshape(exp(Y),n_row,n_col);

%% estimate standard deviations
Mw1 = 4;  Mw2 = 6.5;
c = [4.186 	0.931 	-3.672];
phi = 0.577*ones(size(input_Mw));
tau = 1./(c(1)+c(2).*input_Mw.*log(input_Mw)+c(3).*(log(input_Mw)).^2);
tau(input_Mw<Mw1) = 1./(c(1)+c(2).*Mw1.*log(Mw1)+c(3).*(log(Mw1)).^2);
tau(input_Mw>Mw2) = 1./(c(1)+c(2).*Mw2.*log(Mw2)+c(3).*(log(Mw2)).^2);
sigma = (phi.^2+tau.^2).^0.5;


function y = sigmoid(x)
y = 1./(exp(-x)+1);